import React, { useState, useRef } from 'react';
import { View, Text, Image, TouchableOpacity, StyleSheet} from 'react-native';
import { useNavigation, useRoute } from '@react-navigation/native';
import { FontAwesome } from '@expo/vector-icons';
import { Video } from 'expo-av'; // Import the Video component
import { getDoc, doc, collection, getDocs, query, where, updateDoc, setDoc } from 'firebase/firestore';
import {firestore} from '../firebase';

const Post = ({ imageUrl, description, usernameToDisplay, username, timestamp}) => {
  const navigation = useNavigation();
  const [liked, setLiked] = useState(false);
  const [isPlaying, setIsPlaying] = useState(false); // Added for managing play state
  const videoRef = useRef(null); // Reference to the video for playback control

  const handleLikePress = async () => {
    try {
      setLiked(!liked);
      const userDocRef = doc(collection(firestore, 'profiles'), usernameToDisplay);
  
      // Get the current gnarPoints value
      const profileDocSnap = await getDoc(userDocRef);
      const currentGnarPoints = profileDocSnap.exists() ? profileDocSnap.data()?.gnarPoints || 0 : 0;
  
      // Update the gnarPoints based on whether the post is liked or unliked
      const newGnarPoints = liked ? Math.max(currentGnarPoints - 1, 0) : currentGnarPoints + 1;
  
      // Update the Firestore document with the new gnarPoints value
      await updateDoc(userDocRef, { gnarPoints: newGnarPoints });
  
      // Update the local state to reflect the change
    } catch (error) {
      console.error('Error updating gnarPoints:', error);
    }
  };
  
  

  const IconComponent = FontAwesome;

  const isVideo = (url) => {
    return /\.(mp4|mov)(\?.*)?(#.*)?$/i.test(url);
  };

  // Toggle video playback state
  const handleVideoPress = () => {
    if (isPlaying) {
      videoRef.current?.pauseAsync();
    } else {
      videoRef.current?.playAsync();
    }
    setIsPlaying(!isPlaying); // Toggle play state
  };

  return (
    <View style={styles.container}>
      {imageUrl !== "" && (
        isVideo(imageUrl) ? (
          <TouchableOpacity onPress={handleVideoPress}>
            <Video
              ref={videoRef}
              source={{ uri: imageUrl }}
              style={styles.media}
              resizeMode="cover"
              isLooping
              shouldPlay={isPlaying}
            />
          </TouchableOpacity>
        ) : (
          <Image
            source={{ uri: imageUrl }}
            style={styles.media}
          />
        )
      )}
      <View style={styles.textContainer}>
        <Text style={styles.description}>{description}</Text>
        <View style={styles.footerContainer}>
          {usernameToDisplay && (
            <TouchableOpacity onPress={() => navigation.navigate('GhostProfile', { usertodisplay: usernameToDisplay, username: username })}>
              <Text style={styles.username}>@{usernameToDisplay}</Text>
            </TouchableOpacity>
          )}
          <Text style={styles.timestamp}>{new Date(timestamp.seconds * 1000).toLocaleDateString()}</Text>
          <TouchableOpacity style={styles.likeButton} onPress={handleLikePress}>
            <IconComponent name="thumbs-up" size={30} color={liked ? '#0173f9' : 'gray'} solid={liked} />
          </TouchableOpacity>
        </View>
      </View>
    </View>
  );
};



import React, { useState, useRef } from 'react';
import { View, Text, Image, TouchableOpacity, StyleSheet, Modal} from 'react-native';
import { useNavigation, useRoute } from '@react-navigation/native';
import { FontAwesome } from '@expo/vector-icons';
import { Video } from 'expo-av'; // Import the Video component
import { getDoc, doc, collection, getDocs, query, where, updateDoc, setDoc } from 'firebase/firestore';
import {firestore} from '../firebase';

const Post = ({ imageUrl, description, usernameToDisplay, username, timestamp}) => {
  const navigation = useNavigation();
  const [liked, setLiked] = useState(false);
  const [isPlaying, setIsPlaying] = useState(false); // Added for managing play state
  const videoRef = useRef(null); // Reference to the video for playback control
  const [modalVisible, setModalVisible] = useState(false); // State to control the visibility of the modal

  const handleLikePress = async () => {
    try {
      setLiked(!liked);
      const userDocRef = doc(collection(firestore, 'profiles'), usernameToDisplay);
  
      // Get the current gnarPoints value
      const profileDocSnap = await getDoc(userDocRef);
      const currentGnarPoints = profileDocSnap.exists() ? profileDocSnap.data()?.gnarPoints || 0 : 0;
  
      // Update the gnarPoints based on whether the post is liked or unliked
      const newGnarPoints = liked ? Math.max(currentGnarPoints - 1, 0) : currentGnarPoints + 1;
  
      // Update the Firestore document with the new gnarPoints value
      await updateDoc(userDocRef, { gnarPoints: newGnarPoints });
  
      // Update the local state to reflect the change
    } catch (error) {
      console.error('Error updating gnarPoints:', error);
    }
  };
  

  const toggleModal = () => {
    setModalVisible(!modalVisible);
  };
  

  const IconComponent = FontAwesome;

  const isVideo = (url) => {
    return /\.(mp4|mov)(\?.*)?(#.*)?$/i.test(url);
  };

  // Toggle video playback state
  const handleVideoPress = () => {
    if (isPlaying) {
      videoRef.current?.pauseAsync();
    } else {
      videoRef.current?.playAsync();
    }
    setIsPlaying(!isPlaying); // Toggle play state
  };

  return (
    <View style={styles.container}>
      <TouchableOpacity onPress={toggleModal}>
        {imageUrl !== "" && (
          isVideo(imageUrl) ? (
            <Video
              ref={videoRef}
              source={{ uri: imageUrl }}
              style={styles.fullScreenMedia}
              resizeMode="cover"
              isLooping
              shouldPlay={isPlaying}
              onPlaybackStatusUpdate={status => setIsPlaying(status.isPlaying)}
            />
          ) : (
            <Image
              source={{ uri: imageUrl }}
              style={styles.fullScreenMedia}
            />
          )
        )}
      </TouchableOpacity>
      <View style={styles.textContainer}>
        <Text style={styles.description}>{description}</Text>
        <View style={styles.footerContainer}>
          {usernameToDisplay && (
            <TouchableOpacity onPress={() => navigation.navigate('GhostProfile', { usertodisplay: usernameToDisplay, username: username })}>
              <Text style={styles.username}>@{usernameToDisplay}</Text>
            </TouchableOpacity>
          )}
          <Text style={styles.timestamp}>{new Date(timestamp.seconds * 1000).toLocaleDateString()}</Text>
          <TouchableOpacity style={styles.likeButton} onPress={handleLikePress}>
            <IconComponent name="thumbs-up" size={30} color={liked ? '#0173f9' : 'gray'} solid={liked} />
          </TouchableOpacity>
        </View>
      </View>
  
      {/* Full-screen modal for image/video */}
      <Modal
        animationType="slide"
        transparent={false}
        visible={modalVisible}
        onRequestClose={toggleModal} // This is to handle hardware back button on Android
      >
        <View style={styles.fullScreenContainer}>
          {isVideo(imageUrl) ? (
            <Video
              ref={videoRef}
              source={{ uri: imageUrl }}
              style={styles.fullScreenMedia}
              resizeMode="contain"
              isLooping
              shouldPlay
              useNativeControls
              onPlaybackStatusUpdate={status => setIsPlaying(status.isPlaying)}
            />
          ) : (
            <Image
              source={{ uri: imageUrl }}
              style={styles.fullScreenMedia}
              resizeMode="contain"
            />
          )}
          <TouchableOpacity
            style={styles.closeModalButton}
            onPress={toggleModal}
          >
            <Text style={styles.closeModalText}>Close</Text>
          </TouchableOpacity>
        </View>
      </Modal>
    </View>
  );
};
  export default Post;


const styles = StyleSheet.create({
  container: {
    borderWidth: 1,
    borderColor: 'white',
    marginBottom: 20,
    backgroundColor: 'black',
  },
  fullScreenMedia: {
    width: '100%', // Take up all screen width
    height: '80%', // Take up 80% of screen height
    // Adjust the styles to match your design
  },
  modalView: {
    marginTop: 50,
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: 'black', // Assuming a dark background for media viewing
  },
  closeModalButton: {
    // Style your close button
    position: 'absolute',
    top: 50,
    right: 10,
    padding: 10,
    zIndex: 10, // Make sure it's above other elements
    backgroundColor: '#0173f9', // Just an example
    borderRadius: 5,
    width: 60, 
    alignItems: 'center',
  },
  closeModalText: {
    // Style for the close button text
    color: 'white',
  },
  media: {
    width: 200, // Adjusted for consistency
    height: 200,
    alignSelf: 'center',
  },
  textContainer: {
    padding: 10,
  },
  description: {
    fontSize: 16,
    color: 'white',
  },
  footerContainer: {
    marginTop: 5,
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  likeButton: {
    marginTop: -20,
    marginBottom: -5,
    marginLeft: 7,
    marginRight: 7,
    alignSelf: 'flex-end',
    flexDirection: 'row',
    alignItems: 'center',
  },
  username: {
    marginBottom: -5,
    color: '#0173f9', // The username color
    fontWeight: 'bold',
  },
  timestamp: {
    marginLeft: 170,
    marginBottom: -5,
    color: 'white',
  },

});


